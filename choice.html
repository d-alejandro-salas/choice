<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mixed Quiz — Dynamic Question Set</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* YOUR palette */
      --mainColour: white;    
      --secondColour: red;   
      --borderColour: blue;    

      --muted: #4b5563;
    }

    /* ===== Scroll & Low‑Vision Friendly Base ===== */
    html{height:auto; min-height:100%}
    body{height:auto; min-height:100%; overflow-y:auto; font-family:'Inter',sans-serif; background:var(--borderColour); font-size:clamp(16px, 1.1vw + 0.8rem, 20px);} 
    .container{max-width:min(920px, 100%); width:100%; margin:2rem auto; background:var(--mainColour); border:2px solid var(--borderColour);} 
    .paper{background:transparent;}    
    .card{background:var(--mainColour); border:1px solid var(--borderColour);} 

    .heading{color:var(--borderColour)}
    .text{color:var(--secondColour)}
    .muted{color:var(--muted)}

    /* Progress */

    #quizHeader {border: 1px solid var(--borderColour);}    
    .progressBar span{transition:background-color .3s ease}
    .progressSegment {
      flex: 1 1 0%;
      height: clamp(14px, 1vw + 10px, 20px);
      background: var(--mainColour);
      border: 2px solid var(--borderColour);
      border-radius: 5px;
      box-sizing: border-box;
    }
    .dashOk{background:var(--borderColour)!important;border-color:var(--borderColour)!important}
    .dashBad{background:var(--secondColour)!important;border-color:var(--secondColour)!important}

    /* Key dots (no labels) */
    .keyDot{width:clamp(12px,0.6vw+10px,16px);height:clamp(12px,0.6vw+10px,16px);display:inline-block;border:2px solid var(--borderColour);border-radius:4px}
    .keyBad{background:var(--secondColour);border-color:var(--secondColour)}
    .keyPending{background:#fff;border-color:var(--borderColour)}
    .keyOk{background:var(--borderColour);border-color:var(--borderColour)}

    /* Option tiles */
    .option{border:1px solid var(--borderColour); background:var(--secondColour); transition:box-shadow .2s ease,border-color .2s ease, opacity .2s ease, filter .2s ease; border-radius:1rem; padding:clamp(12px, 1.2vw + 8px, 22px)}
    .option:hover{box-shadow:0 0 0 3px rgba(0,0,0,.06) inset}
    .option .optionText{color:#ffffff; font-size:clamp(1rem, 1.2vw + .6rem, 1.35rem)}

    /* DESCARTE: bloquea la opción (deshabilita clics) pero NO la tacha */
    .option.discarded{opacity:.45; pointer-events:none; filter:grayscale(.4)}
    .option.discarded .optionText{text-decoration:none}

    .option:focus{outline:3px solid var(--borderColour); outline-offset:2px}

    /* ABCDE label — forced white; in feedback states we recolor if needed */
    .labelLetter{color:#ffffff; font-weight:700; display:inline-block; min-width:1.4ch; text-align:center; margin-right:1rem}

    .feedbackMode .option{pointer-events:none}
    .feedbackMode .option:not(.correct):not(.incorrect){opacity:.7}

    /* Correct = bordered/outlined with BLUE; readable white tile switch */
    .feedbackMode .option.correct{background:var(--mainColour); border-color:var(--borderColour)}
    .feedbackMode .option.correct .optionText{color:var(--secondColour)}
    .feedbackMode .option.correct .labelLetter{color:var(--borderColour)}

    /* Incorrect */
    .feedbackMode .option.incorrect{background:var(--secondColour); border-color:var(--secondColour)}
    .feedbackMode .option.incorrect .optionText{color:#fff}
    .feedbackMode .option.incorrect .labelLetter{color:#fff}

    .feedbackIcon{display:none}
    .feedbackMode .option.correct .feedbackIcon.correct{display:inline-block; color:var(--borderColour)}
    .feedbackMode .option.incorrect .feedbackIcon.incorrect{display:inline-block; color:#fff}

    /* Buttons */
    .btn{background:var(--mainColour); color:var(--secondColour); border:1px solid var(--borderColour); border-radius:1rem; transition:filter .2s ease; font-size:clamp(1rem, 1.2vw + .6rem, 1.35rem)}
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Icons */
    .icon-ok{color:var(--borderColour)}
    .iconBad{color:var(--secondColour)}
    .discardBtn{color:var(--mainColour)}

    @media (max-width: 420px){
      .container{border-width:1.5px; margin:1rem auto}
      .paper{border-width:1px}
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen p-4">
  <section class="container rounded-2xl shadow-xl p-4 sm:p-8" role="region" aria-label="Mixed quiz">

    <!-- SETUP: el usuario pega aquí su propio arreglo de preguntas -->
    <div id="setupArea" class="paper rounded-xl p-4 sm:p-5 mb-6 text-center">
      <h1 class="heading font-bold mb-4" style="font-size:clamp(1.4rem, 1.5vw + 1.1rem, 2.2rem)">Inserte aquí su arreglo</h1>
      <textarea id="questionsInput" class="w-full border border-slate-300 rounded-lg p-2 text-xs font-mono h-52" placeholder="Pegue aquí su arreglo..."></textarea>
      <p id="setupError" class="mt-2 text-sm text-red-600 hidden"></p>
      <button id="loadQuizBtn" class="mt-4 w-full py-3 font-semibold btn" aria-label="Cargar preguntas y comenzar">Cargar</button class="mt-4 w-full py-3 font-semibold btn" aria-label="Cargar preguntas y comenzar">
        Cargar preguntas y comenzar
      </button>
    </div>

    <!-- CONTENIDO DEL QUIZ (se muestra solo tras cargar las preguntas) -->
    <div id="quizArea" class="hidden">
      <div id="quizHeader" class="paper rounded-xl p-3 sm:p-4 mb-6">
        <div class="flex items-center gap-3">
          <div id="progressBar" class="progressBar flex-grow flex items-center gap-2" aria-label="Progress"></div>
          <span id="progressText" class="font-semibold heading" aria-live="polite"></span>
        </div>
      </div>

      <div id="questionArea" class="paper rounded-xl p-4 sm:p-5">
        <h2 id="questionTitle" class="heading font-bold mb-4" style="font-size:clamp(1.25rem, 1.4vw + 1rem, 2rem)"></h2>
        <ul id="optionsContainer" class="space-y-3" role="listbox" aria-labelledby="questionTitle"></ul>
      </div>

      <div id="resultsArea" class="hidden paper rounded-xl p-4 sm:p-5 mt-6">
        <h2 class="text-center heading font-bold" style="font-size:clamp(1.5rem, 1.6vw + 1.2rem, 2.2rem)">Quiz Completed</h2>
        <p class="text-center muted mb-6">Here are your results.</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
          <div class="card p-4 rounded-lg">
            <p class="muted" style="font-size:.95rem">Score</p>
            <p id="scoreText" class="heading font-bold" style="font-size:clamp(1.4rem, 1.4vw + 1rem, 2rem)"></p>
          </div>
          <div class="card p-4 rounded-lg">
            <p class="muted" style="font-size:.95rem">Accuracy</p>
            <p id="accuracyText" class="heading font-bold" style="font-size:clamp(1.4rem, 1.4vw + 1rem, 2rem)"></p>
          </div>
          <div class="card p-4 rounded-lg">
            <p class="muted" style="font-size:.95rem">Results</p>
            <div class="heading font-bold" style="font-size:clamp(1.1rem, 1.2vw + .8rem, 1.6rem)">
              <span id="correctCount"></span> / <span id="incorrectCount" class="text"></span>
            </div>
          </div>
        </div>

        <div id="feedbackContainer" class="card rounded-xl p-4">
          <h3 class="heading font-bold mb-4" style="font-size:clamp(1.25rem, 1.4vw + 1rem, 1.75rem)">Review Your Answers</h3>
          <p id="feedbackSummary" class="mb-6 muted"></p>
          <div id="detailedFeedback" class="space-y-4"></div>
        </div>

        <button id="restartBtn" class="mt-8 w-full py-3 font-semibold btn" aria-label="Restart quiz">
          Take Quiz Again
        </button>
      </div>

      <div id="navContainer" class="mt-8 pt-2">
        <button id="navBtn" class="w-full py-3 font-semibold btn" aria-label="Next question">
          Next Question
        </button>
      </div>
    </div>
  </section>

  <script>
    // Utilities
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    // Data (se cargará dinámicamente desde el textarea)
    let baseQuizData = [];
    let quizData = [];

    // Progress bar
    function setupProgressBar(){
      progressBar.innerHTML = '';
      quizData.forEach(() => {
        const barSegment = document.createElement('span');
        barSegment.className = 'progressSegment';
        progressBar.appendChild(barSegment);
      });
    }
    function updateProgressBar(status){
      const segment = progressBar.children[currentQuestionIndex];
      if(!segment) return;
      segment.classList.add(status === 'correct' ? 'dashOk' : 'dashBad');
    }

    // Estado global del quiz
    let currentQuestionIndex = 0;
    let score = 0;
    let userAnswers = [];

    // Elementos DOM
    const setupArea = document.getElementById('setupArea');
    const questionsInput = document.getElementById('questionsInput');
    const setupError = document.getElementById('setupError');
    const loadQuizBtn = document.getElementById('loadQuizBtn');

    const quizArea = document.getElementById('quizArea');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const questionTitle = document.getElementById('questionTitle');
    const optionsContainer = document.getElementById('optionsContainer');
    const navBtn = document.getElementById('navBtn');
    const questionArea = document.getElementById('questionArea');
    const resultsArea = document.getElementById('resultsArea');
    const scoreText = document.getElementById('scoreText');
    const accuracyText = document.getElementById('accuracyText');
    const correctCount = document.getElementById('correctCount');
    const incorrectCount = document.getElementById('incorrectCount');
    const restartBtn = document.getElementById('restartBtn');
    const feedbackSummary = document.getElementById('feedbackSummary');
    const detailedFeedback = document.getElementById('detailedFeedback');

    function prepareQuizData(){
      quizData = shuffle(baseQuizData).map(q => ({ ...q, options: shuffle(q.options) }));
    }

    function startQuiz(){
      currentQuestionIndex = 0;
      score = 0;
      userAnswers = Array(quizData.length).fill(null);
      resultsArea.classList.add('hidden');
      questionArea.classList.remove('hidden');
      setupProgressBar();
      showQuestion();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showQuestion(){
      const currentQuestion = quizData[currentQuestionIndex];
      progressText.textContent = `${currentQuestionIndex + 1} of ${quizData.length}`;
      questionTitle.textContent = `${currentQuestionIndex + 1}. ${currentQuestion.question}`;

      optionsContainer.innerHTML = '';
      optionsContainer.classList.remove('feedbackMode');

      currentQuestion.options.forEach((option, index) => {
        const li = document.createElement('li');
        li.className = 'option flex items-center justify-between cursor-pointer';
        li.tabIndex = 0; // keyboard focus
        li.dataset.index = index;
        li.setAttribute('role','option');
        li.setAttribute('aria-selected','false');
        li.innerHTML = `
          <div class="flex items-center">
            <span class="labelLetter">${String.fromCharCode(65 + index)}</span>
            <span class="optionText">${option.text}</span>
          </div>
          <div class="flex items-center">
            <span class="feedbackIcon correct font-bold mr-2 icon-ok" aria-hidden="true">✔</span>
            <span class="feedbackIcon incorrect font-bold mr-2 iconBad" aria-hidden="true">✘</span>
            <button class="discardBtn font-bold text-2xl leading-none px-2 rounded-full transition" title="Bloquear opción" aria-label="Bloquear opción">&times;</button>
          </div>`;
        optionsContainer.appendChild(li);
      });

      navBtn.disabled = true;
      navBtn.textContent = (currentQuestionIndex === quizData.length - 1) ? 'View Results' : 'Next Question';
      attachOptionListeners();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function attachOptionListeners(){
      optionsContainer.querySelectorAll('.option').forEach(optionEl => {
        optionEl.addEventListener('click', (e) => {
          const discardBtnEl = e.target.closest('.discardBtn');
          if(discardBtnEl){
            e.stopPropagation();
            optionEl.classList.toggle('discarded'); // bloquea / desbloquea
          } else {
            handleAnswer(parseInt(optionEl.dataset.index, 10));
          }
        });
        optionEl.addEventListener('keydown', (e) => {
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            handleAnswer(parseInt(optionEl.dataset.index, 10));
          }
        });
      });
    }

    function handleAnswer(selectedIndex){
      // prevent double-answering
      if(optionsContainer.classList.contains('feedbackMode')) return;

      const q = quizData[currentQuestionIndex];
      const isCorrect = q.options[selectedIndex].correct;
      userAnswers[currentQuestionIndex] = { selectedIndex, correct: isCorrect };
      if(isCorrect){
        score++;
        updateProgressBar('correct');
      } else {
        updateProgressBar('incorrect');
      }

      optionsContainer.classList.add('feedbackMode');
      const options = optionsContainer.querySelectorAll('.option');
      options.forEach((opt, idx) => {
        const optionData = q.options[idx];
        if(optionData.correct) opt.classList.add('correct');
        else if(idx === selectedIndex) opt.classList.add('incorrect');
      });

      navBtn.disabled = false;
    }

    function toggleDiscard(index){
      const optionEl = optionsContainer.children[index];
      if(!optionEl) return;
      // allow discarding only before answering
      if(optionsContainer.classList.contains('feedbackMode')) return;
      optionEl.classList.toggle('discarded');
    }

    function handleNavButtonClick(){
      currentQuestionIndex++;
      if(currentQuestionIndex < quizData.length) showQuestion();
      else showResults();
    }

    function showResults(){
      questionArea.classList.add('hidden');
      resultsArea.classList.remove('hidden');
      const accuracy = Math.round((score / quizData.length) * 100);
      scoreText.textContent = `${score}/${quizData.length}`;
      accuracyText.textContent = `${accuracy}%`;
      correctCount.textContent = score;
      incorrectCount.textContent = quizData.length - score;
      generateDetailedFeedback();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function generateDetailedFeedback(){
      detailedFeedback.innerHTML = '';
      const incorrectAnswers = userAnswers.filter(a => a && !a.correct);
      if(incorrectAnswers.length === 0){
        feedbackSummary.textContent = 'Faultless.';
      } else {
        feedbackSummary.textContent = 'Review the items below to tighten your knowledge.';
        userAnswers.forEach((answer, index) => {
          if(answer && !answer.correct){
            const q = quizData[index];
            const correctOption = q.options.find(o => o.correct);
            const selectedOption = q.options[answer.selectedIndex];
            const card = document.createElement('div');
            card.className = 'card p-4 rounded-lg';
            card.innerHTML = `
              <p class="font-bold text">${index + 1}. ${q.question}</p>
              <p class="mt-2 iconBad">Your answer: <span class="font-semibold">${selectedOption.text}</span></p>
              <p class="mt-1 icon-ok">Correct answer: <span class="font-semibold">${correctOption.text}</span></p>
              <p class="mt-2 text-sm muted"><span class="font-semibold text">Explanation:</span> ${q.explanation || ''}</p>`;
            detailedFeedback.appendChild(card);
          }
        });
      }
    }

    // === Keyboard controls ===
    // A/B/C/D/E -> answer; Shift + (A-E) -> discard; N -> next (only when enabled)
    document.addEventListener('keydown', (e) => {
      // Block when results are shown or quiz no iniciado
      if(!quizArea || quizArea.classList.contains('hidden')) return;
      if(!questionArea || questionArea.classList.contains('hidden')) return;

      const key = e.key.toLowerCase();
      const letters = ['a','b','c','d','e'];

      if(letters.includes(key)){
        const idx = key.charCodeAt(0) - 97; // a=0
        if(idx < optionsContainer.children.length){
          if(e.shiftKey){
            // toggle discard before answering
            e.preventDefault();
            toggleDiscard(idx);
          } else {
            e.preventDefault();
            handleAnswer(idx);
          }
        }
      } else if(key === 'n'){
        e.preventDefault();
        if(!navBtn.disabled){ handleNavButtonClick(); }
      }
    });

    navBtn.addEventListener('click', handleNavButtonClick);
    restartBtn.addEventListener('click', () => {
      // reinicia con las mismas preguntas ya cargadas
      prepareQuizData();
      startQuiz();
    });

    // Cargar preguntas desde el textarea
    function parseQuestionsFromInput(){
      const raw = questionsInput.value.trim();
      if(!raw){
        setupError.textContent = 'Pegue un arreglo de preguntas antes de comenzar.';
        setupError.classList.remove('hidden');
        return;
      }

      let parsed;
      try {
        // Si incluye una asignación tipo "const baseQuizData = [...]" o "let baseQuizData = [...]"
        if(/baseQuizData\s*=/.test(raw)){
          parsed = (new Function(raw + '\n; return baseQuizData;'))();
        } else {
          // Asumimos que es directamente un array: [...]
          parsed = (new Function('return ' + raw))();
        }
      } catch(err){
        console.error(err);
        setupError.textContent = 'No pude interpretar el arreglo. Asegúrese de pegar un Array JS válido, como [ { question: "...", options: [...] }, ... ].';
        setupError.classList.remove('hidden');
        return;
      }

      if(!Array.isArray(parsed) || parsed.length === 0){
        setupError.textContent = 'El arreglo debe ser un Array con al menos un objeto de pregunta.';
        setupError.classList.remove('hidden');
        return;
      }

      baseQuizData = parsed;
      setupError.classList.add('hidden');

      prepareQuizData();
      setupArea.classList.add('hidden');
      quizArea.classList.remove('hidden');
      startQuiz();
    }

    loadQuizBtn.addEventListener('click', parseQuestionsFromInput);
  </script>
</body>
</html>
