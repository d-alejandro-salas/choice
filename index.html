<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mixed Quiz — Dynamic Question Set</title>
  
  <!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ENG: CSS Variables for easy theming (Original palette restored)
      CAST: Variables CSS para cambiar el tema fácilmente (Paleta original restaurada)
    */
    :root {
      --mainColour: white;      /* Original: White */
      --secondColour: red;      /* Original: Red */
      --borderColour: blue;     /* Original: Blue */
      --muted: #4b5563;         /* Original: Muted gray */

      /* ENG: New variables for consistency based on original palette
        CAST: Nuevas variables para consistencia basadas en la paleta original */
      --text-heading: var(--borderColour);
      --text-secondary: var(--secondColour);
      --text-default: #1f2937; /* A dark gray for general text */
      --bg-body: var(--borderColour);
      --bg-card: var(--mainColour);
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body); /* Original body background */
      color: var(--text-default);
      font-size: clamp(16px, 1.1vw + 0.8rem, 20px); /* Original font size */
    }

    /* ENG: General container and paper styles (Restored from original)
      CAST: Estilos generales del contenedor y "papel" (Restaurados del original)
    */
    .container {
      max-width: min(920px, 100%);
      width: 100%;
      margin: 2rem auto;
      background: var(--bg-card);
      border: 2px solid var(--borderColour);
      border-radius: 1rem; /* Added for consistency with original structure */
    }
    .paper { background: transparent; }
    .card { background: var(--bg-card); border: 1px solid var(--borderColour); }

    /* ENG: Heading and Text colors (Restored from original)
      CAST: Colores de encabezados y texto (Restaurados del original)
    */
    .heading { color: var(--text-heading); }
    .text { color: var(--text-secondary); }
    .muted { color: var(--muted); }

    /* ENG: Custom Progress Bar Segments (Adjusted to original palette)
      CAST: Segmentos personalizados de la barra de progreso (Ajustados a la paleta original)
    */
    .progress-bar-segment {
      height: clamp(14px, 1vw + 10px, 20px); /* Original height */
      background-color: var(--mainColour);
      border: 2px solid var(--borderColour);
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .progress-bar-segment.correct { background-color: var(--borderColour); border-color: var(--borderColour); }
    .progress-bar-segment.incorrect { background-color: var(--secondColour); border-color: var(--secondColour); }

    /* ENG: Option Styles (Interactive items, adjusted to original palette)
      CAST: Estilos de las opciones (Ítems interactivos, ajustados a la paleta original)
    */
    .option-card {
      border: 1px solid var(--borderColour); /* Original border */
      background: var(--secondColour); /* Original background */
      transition: box-shadow .2s ease, border-color .2s ease, opacity .2s ease, filter .2s ease;
      border-radius: 1rem;
      padding: clamp(12px, 1.2vw + 8px, 22px);
    }
    
    .option-card:hover:not(.disabled) {
      box-shadow: 0 0 0 3px rgba(0,0,0,.06) inset;
    }

    /* Focus accessibility */
    .option-card:focus-visible {
      outline: 3px solid var(--borderColour); /* Original outline */
      outline-offset: 2px;
    }

    .option-card .option-text {
        color: #ffffff; /* Original text color */
        font-size: clamp(1rem, 1.2vw + .6rem, 1.35rem);
    }
    .option-card .label-letter {
        color: #ffffff; /* Original label letter color */
        font-weight: 700;
        display: inline-block;
        min-width: 1.4ch;
        text-align: center;
        margin-right: 1rem;
    }

    /* ENG: State: Discarded (Shift + Click)
      CAST: Estado: Descartado/Bloqueado (Shift + Click)
    */
    .option-card.discarded {
      opacity: 0.45; /* Original opacity */
      filter: grayscale(.4); /* Original grayscale */
      pointer-events: none;
    }
    .option-card.discarded .option-text { text-decoration: none; } /* Original style */


    /* ENG: Feedback States (After answering, adjusted to original palette)
      CAST: Estados de Feedback (Después de responder, ajustados a la paleta original)
    */
    .feedback-mode .option-card { pointer-events: none; }
    .feedback-mode .option-card:not(.is-correct):not(.is-wrong) { opacity: .7; } /* Original opacity for unselected */

    .feedback-mode .option-card.is-correct {
      background: var(--mainColour); /* Original background */
      border-color: var(--borderColour); /* Original border */
    }
    .feedback-mode .option-card.is-correct .option-text { color: var(--secondColour); } /* Original text color */
    .feedback-mode .option-card.is-correct .label-letter { color: var(--borderColour); } /* Original label letter color */


    .feedback-mode .option-card.is-wrong {
      background: var(--secondColour); /* Original background */
      border-color: var(--secondColour); /* Original border */
    }
    .feedback-mode .option-card.is-wrong .option-text { color: #fff; } /* Original text color */
    .feedback-mode .option-card.is-wrong .label-letter { color: #fff; } /* Original label letter color */

    /* ENG: Feedback Icons (Correct/Incorrect)
      CAST: Iconos de Feedback (Correcto/Incorrecto)
    */
    .feedback-icon { display: none; }
    .feedback-mode .option-card.is-correct .feedback-icon.correct { display: inline-block; color: var(--borderColour); }
    .feedback-mode .option-card.is-wrong .feedback-icon.incorrect { display: inline-block; color: #fff; }

    /* ENG: Discard Button Specifics (Redesigned as requested: red cross, white background, blue border)
      CAST: Estilos específicos del botón de descarte (Rediseñado según solicitado: cruz roja, fondo blanco, borde azul)
    */
    .btn-discard {
      background-color: var(--mainColour); /* White background */
      color: var(--secondColour); /* Red cross */
      border: 2px solid var(--borderColour); /* Blue border */
      border-radius: 50%; /* Circular shape */
      width: 2.2em; /* Ensure it's a good size */
      height: 2.2em;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem; /* Adjust font size for cross */
      line-height: 1; /* Center the 'x' */
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s, color 0.2s;
    }
    .btn-discard:hover {
      background-color: var(--secondColour); /* Red background on hover */
      color: var(--mainColour); /* White cross on hover */
    }
    .option-card.discarded .btn-discard {
        background-color: var(--borderColour); /* Blue when discarded */
        color: var(--mainColour); /* White cross when discarded */
    }
    .option-card.discarded .btn-discard:hover {
        background-color: var(--borderColour); /* Keep blue on hover when discarded */
        color: var(--mainColour); /* Keep white cross on hover when discarded */
    }

    /* ENG: Buttons (Restored from original)
      CAST: Botones (Restaurados del original)
    */
    .btn {
      background: var(--mainColour);
      color: var(--secondColour);
      border: 1px solid var(--borderColour);
      border-radius: 1rem;
      transition: filter .2s ease;
      font-size: clamp(1rem, 1.2vw + .6rem, 1.35rem);
    }
    .btn:hover { filter: brightness(1.05); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Timer Animation */
    @keyframes pulse-red {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .timer-low {
      color: var(--secondColour);
      animation: pulse-red 1s infinite;
    }

    /* Media Queries */
    @media (max-width: 420px){
      .container{border-width:1.5px; margin:1rem auto}
    }

    /* ENG: Developer Footer Styles
       CAST: Estilos del Footer del Desarrollador */
    .dev-footer {
      /* Resetting fixed position to flow */
      margin-top: 2rem;
      width: 100%;
      max-width: min(920px, 100%); /* Align width with main container */
      text-align: center;
      padding: 1rem;
      font-size: 0.8rem;
      color: var(--muted);
      
      /* Visual flair consistent with theme */
      border-top: 2px solid var(--borderColour);
      background-color: var(--mainColour);
      border-radius: 1rem;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

  <main class="container rounded-2xl shadow-xl p-4 sm:p-8">
    
    <!-- 
      SECTION 1: SETUP AREA 
      ENG: Area where user pastes the JSON/Array 
      CAST: Área donde el usuario pega el JSON/Array
    --><section id="setup-view" class="paper rounded-xl p-4 sm:p-5 mb-6 text-center">
      <h1 class="heading font-bold mb-4" style="font-size:clamp(1.4rem, 1.5vw + 1.1rem, 2.2rem)">
        Insert your Question Array
      </h1>
      <textarea id="input-data" 
        class="w-full border border-gray-300 rounded-lg p-2 text-xs font-mono h-40 bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none" 
        placeholder='[ { "question": "Example?", "options": [...] } ]'></textarea>
      
      <!-- Timer Configuration -->
      <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2 text-sm">
        <label for="timer-input" class="font-semibold text-gray-600">Timer per question (seconds):</label>
        <input type="number" id="timer-input" 
          class="border border-gray-300 rounded p-2 w-24 text-center text-lg font-bold text-blue-600 focus:ring-2 focus:ring-blue-500 outline-none" 
          value="60" min="5" max="600">
      </div>

      <p id="error-msg" class="mt-2 text-sm text-red-600 hidden"></p>
      
      <button id="btn-load" class="mt-4 w-full py-3 font-semibold btn" aria-label="Load questions and start">
        Load & Start Quiz
      </button>
    </section>

    <!-- 
      SECTION 2: QUIZ INTERFACE 
      ENG: The active quiz view (Hidden by default)
      CAST: La vista activa del quiz (Oculta por defecto)
    --><section id="quiz-view" class="hidden">
      <!-- Header: Progress & Timer -->
      <div id="quizHeader" class="paper rounded-xl p-3 sm:p-4 mb-6">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <span class="text-xl">⏱️</span>
            <span id="timer-display" class="font-bold text-xl heading font-mono">60s</span>
          </div>
          <span id="progress-text" class="font-semibold heading" aria-live="polite"></span>
        </div>
        
        <div id="progress-bar" class="progressBar flex items-center gap-2" aria-label="Progress">
          <!-- JS will inject segments here -->
        </div>
      </div>

      <!-- Question Content --><div id="questionArea" class="paper rounded-xl p-4 sm:p-5">
        <h2 id="question-text" class="heading font-bold mb-4" style="font-size:clamp(1.25rem, 1.4vw + 1rem, 2rem)"></h2>
        
        <ul id="options-list" class="space-y-3" role="listbox" aria-labelledby="question-text">
          <!-- JS will inject options here --></ul>
      </div>

      <!-- Footer: Navigation --><div id="navContainer" class="mt-8 pt-2">
        <button id="btn-next" class="w-full py-3 font-semibold btn" aria-label="Next question">
          Next Question
        </button>
        <p class="text-center text-xs text-gray-400 mt-3">
          Keyboard: <strong>A-E</strong> to answer • <strong>Shift + A-E</strong> to discard • <strong>N</strong> for next
        </p>
      </div>
    </section>

    <!-- 
      SECTION 3: RESULTS 
      ENG: Final summary
      CAST: Resumen final
    --><section id="results-view" class="hidden paper rounded-xl p-4 sm:p-5 mt-6">
      <h2 class="text-center heading font-bold" style="font-size:clamp(1.5rem, 1.6vw + 1.2rem, 2.2rem)">
        Quiz Completed!
      </h2>
      <p class="text-center muted mb-6">Here are your results.</p>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-8">
        <div class="card p-4 rounded-lg">
          <p class="muted" style="font-size:.95rem">Score</p>
          <p id="final-score" class="heading font-bold" style="font-size:clamp(1.4rem, 1.4vw + 1rem, 2rem)"></p>
        </div>
        <div class="card p-4 rounded-lg">
          <p class="muted" style="font-size:.95rem">Accuracy</p>
          <p id="final-accuracy" class="heading font-bold" style="font-size:clamp(1.4rem, 1.4vw + 1rem, 2rem)"></p>
        </div>
        <div class="card p-4 rounded-lg">
          <p class="muted" style="font-size:.95rem">Results</p>
          <div class="heading font-bold" style="font-size:clamp(1.1rem, 1.2vw + .8rem, 1.6rem)">
            <span id="correct-count"></span> / <span id="incorrect-count" class="text"></span>
          </div>
        </div>
      </div>

      <!-- Detailed Feedback Loop --><div id="feedback-container" class="card rounded-xl p-4">
        <h3 class="heading font-bold mb-4" style="font-size:clamp(1.25rem, 1.4vw + 1rem, 1.75rem)">
          Review Your Answers
        </h3>
        <p id="feedback-summary" class="mb-6 muted"></p>
        <div id="feedback-list" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
      </div>

      <button id="btn-restart" class="mt-8 w-full py-3 font-semibold btn" aria-label="Restart quiz">
        Take Quiz Again
      </button>
    </section>

  </main>

  <!-- Developer Footer -->
  <footer class="dev-footer">
    <p>
      Web Developer Daniel Alejandro, hiring: 
      <a href="mailto:daniel.salas@bue.edu.ar" class="text-blue-600 hover:underline">daniel.salas@bue.edu.ar</a>. 
      © All rights reserved <span id="yearPlaceholder"></span>.
    </p>
  </footer>

  <script>
    /**
     * QUIZ APPLICATION LOGIC
     * ENG: Encapsulated logic to avoid global variable pollution.
     * CAST: Lógica encapsulada para evitar contaminar variables globales.
     */
    const QuizApp = {
      // State
      questions: [],
      currentIndex: 0,
      score: 0,
      userHistory: [], // Stores { selectedIndex, isCorrect, timedOut }
      
      // Timer State
      timerSettings: { duration: 60 },
      timeLeft: 60,
      timerInterval: null,

      // DOM Elements Cache
      ui: {
        setupView: document.getElementById('setup-view'),
        quizView: document.getElementById('quiz-view'),
        resultsView: document.getElementById('results-view'),
        inputData: document.getElementById('input-data'),
        timerInput: document.getElementById('timer-input'),
        errorMsg: document.getElementById('error-msg'),
        
        questionText: document.getElementById('question-text'),
        optionsList: document.getElementById('options-list'),
        progressBar: document.getElementById('progress-bar'),
        progressText: document.getElementById('progress-text'),
        timerDisplay: document.getElementById('timer-display'),
        
        btnNext: document.getElementById('btn-next'),
        finalScore: document.getElementById('final-score'),
        finalAccuracy: document.getElementById('final-accuracy'),
        correctCount: document.getElementById('correct-count'),
        incorrectCount: document.getElementById('incorrect-count'),
        feedbackSummary: document.getElementById('feedback-summary'),
        feedbackList: document.getElementById('feedback-list')
      },

      /**
       * ENG: Utility to shuffle arrays (Fisher-Yates)
       * CAST: Utilidad para mezclar arrays (Fisher-Yates)
       */
      shuffle(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      },

      /**
       * ENG: Load and Parse Data
       * CAST: Cargar y procesar datos
       */
      loadData() {
        const raw = this.ui.inputData.value.trim();
        // Set Timer Duration from Input
        const timerVal = parseInt(this.ui.timerInput.value, 10);
        this.timerSettings.duration = (timerVal && timerVal > 0) ? timerVal : 60;

        if (!raw) return this.showError('Please paste your data array first.');

        try {
          // ENG: Try secure JSON parsing first, fallback to function eval for loose JS objects
          // CAST: Intenta parseo JSON seguro primero, recurre a eval de función para objetos JS sueltos
          let data;
          try {
            data = JSON.parse(raw);
          } catch (e) {
            data = new Function(`return ${raw}`)();
          }

          if (!Array.isArray(data) || data.length === 0) throw new Error('Data is not a valid array.');
          
          // ENG: Prepare Data (Shuffle questions AND options)
          // CAST: Preparar datos (Mezclar preguntas Y opciones)
          this.questions = this.shuffle(data).map(q => ({
            ...q,
            options: this.shuffle(q.options)
          }));

          this.startQuiz();
        } catch (err) {
          console.error(err);
          this.showError('Invalid data format. Ensure it is a valid Javascript Array.');
        }
      },

      showError(msg) {
        this.ui.errorMsg.textContent = msg;
        this.ui.errorMsg.classList.remove('hidden');
      },

      /**
       * ENG: Initialize Quiz State
       * CAST: Inicializar estado del Quiz
       */
      startQuiz() {
        this.currentIndex = 0;
        this.score = 0;
        this.userHistory = new Array(this.questions.length).fill(null);
        
        this.ui.setupView.classList.add('hidden');
        this.ui.resultsView.classList.add('hidden');
        this.ui.quizView.classList.remove('hidden');
        this.ui.errorMsg.classList.add('hidden');

        this.renderProgressBar();
        this.renderQuestion();
      },

      /**
       * ENG: Render Progress Bar (Segments)
       * CAST: Renderizar Barra de Progreso (Segmentos)
       */
      renderProgressBar() {
        this.ui.progressBar.innerHTML = '';
        this.questions.forEach((_, idx) => {
          const seg = document.createElement('div');
          seg.className = 'progress-bar-segment flex-1';
          seg.id = `prog-${idx}`;
          this.ui.progressBar.appendChild(seg);
        });
      },

      updateProgressDot(status) {
        const dot = document.getElementById(`prog-${this.currentIndex}`);
        if (dot) dot.classList.add(status);
      },

      /**
       * ENG: Timer Logic
       * CAST: Lógica del Temporizador
       */
      startTimer() {
        clearInterval(this.timerInterval);
        this.timeLeft = this.timerSettings.duration;
        this.updateTimerDisplay();

        this.timerInterval = setInterval(() => {
          this.timeLeft--;
          this.updateTimerDisplay();

          if (this.timeLeft <= 0) {
            this.handleTimeout();
          }
        }, 1000);
      },

      updateTimerDisplay() {
        this.ui.timerDisplay.textContent = `${this.timeLeft}s`;
        if (this.timeLeft <= 10) {
          this.ui.timerDisplay.classList.add('timer-low');
        } else {
          this.ui.timerDisplay.classList.remove('timer-low');
        }
      },

      handleTimeout() {
        clearInterval(this.timerInterval);
        
        // Record as incorrect (Time Out)
        this.userHistory[this.currentIndex] = { selectedIndex: -1, isCorrect: false, timedOut: true };
        this.updateProgressDot('incorrect');

        // Show Feedback
        this.ui.optionsList.classList.add('feedback-mode');
        this.ui.questionText.innerHTML += ' <span style="color:var(--secondColour)">(Time Out!)</span>';
        
        const q = this.questions[this.currentIndex];
        const domOptions = Array.from(this.ui.optionsList.children);

        domOptions.forEach((el, idx) => {
          const optData = q.options[idx];
          if (optData.correct) {
            el.classList.add('is-correct'); // Reveal correct
          }
        });

        this.ui.btnNext.disabled = false;
      },

      /**
       * ENG: Display Current Question
       * CAST: Mostrar pregunta actual
       */
      renderQuestion() {
        const q = this.questions[this.currentIndex];
        
        // Update Header
        this.ui.progressText.textContent = `${this.currentIndex + 1} of ${this.questions.length}`;
        this.ui.questionText.textContent = `${this.currentIndex + 1}. ${q.question}`;
        
        // Reset UI
        this.ui.btnNext.disabled = true;
        this.ui.btnNext.textContent = (this.currentIndex === this.questions.length - 1) ? 'View Results' : 'Next Question';
        this.ui.optionsList.innerHTML = '';
        this.ui.optionsList.classList.remove('feedback-mode');

        q.options.forEach((opt, idx) => {
          const li = document.createElement('li');
          li.className = 'option-card flex items-center justify-between cursor-pointer';
          li.tabIndex = 0;
          li.dataset.index = idx;
          li.setAttribute('role','option');
          li.setAttribute('aria-selected','false');
          
          const letter = String.fromCharCode(65 + idx);
          
          li.innerHTML = `
            <div class="flex items-center">
              <span class="label-letter">${letter}</span>
              <span class="option-text">${opt.text}</span>
            </div>
            <div class="flex items-center">
              <span class="feedback-icon correct font-bold mr-2" aria-hidden="true">✔</span>
              <span class="feedback-icon incorrect font-bold mr-2" aria-hidden="true">✘</span>
              <button class="btn-discard font-bold" title="Bloquear opción" aria-label="Bloquear opción">&times;</button>
            </div>
          `;

          // Listeners
          li.addEventListener('click', (e) => {
            const discardBtnEl = e.target.closest('.btn-discard');
            if (discardBtnEl) {
              e.stopPropagation();
              this.toggleDiscard(li);
            } else {
              this.handleAnswer(idx);
            }
          });
          
          li.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              this.handleAnswer(idx);
            }
          });

          this.ui.optionsList.appendChild(li);
        });

        window.scrollTo({ top: 0, behavior: 'smooth' });
        this.startTimer(); // Start countdown
      },

      toggleDiscard(element) {
        if (this.ui.optionsList.classList.contains('feedback-mode')) return;
        element.classList.toggle('discarded');
      },

      /**
       * ENG: Process User Answer
       * CAST: Procesar respuesta del usuario
       */
      handleAnswer(selectedIndex) {
        if (this.ui.optionsList.classList.contains('feedback-mode')) return; 

        clearInterval(this.timerInterval); // STOP TIMER

        const q = this.questions[this.currentIndex];
        const isCorrect = q.options[selectedIndex].correct;
        
        // Record history
        this.userHistory[this.currentIndex] = { selectedIndex, isCorrect, timedOut: false };
        
        if (isCorrect) {
          this.score++;
          this.updateProgressDot('correct');
        } else {
          this.updateProgressDot('incorrect');
        }

        // UI Feedback
        this.ui.optionsList.classList.add('feedback-mode');
        const domOptions = Array.from(this.ui.optionsList.children);

        domOptions.forEach((el, idx) => {
          const optData = q.options[idx];
          
          if (optData.correct) {
            el.classList.add('is-correct'); 
          } 
          if (idx === selectedIndex && !optData.correct) {
            el.classList.add('is-wrong'); 
          }
        });

        this.ui.btnNext.disabled = false;
        this.ui.btnNext.focus();
      },

      nextQuestion() {
        clearInterval(this.timerInterval); // Safety clear
        this.currentIndex++;
        if (this.currentIndex < this.questions.length) {
          this.renderQuestion();
        } else {
          this.showResults();
        }
      },

      /**
       * ENG: Show Final Results
       * CAST: Mostrar resultados finales
       */
      showResults() {
        clearInterval(this.timerInterval); // Ensure stopped
        this.ui.quizView.classList.add('hidden');
        this.ui.resultsView.classList.remove('hidden');

        // Stats
        const accuracy = Math.round((this.score / this.questions.length) * 100);
        this.ui.finalScore.textContent = `${this.score} / ${this.questions.length}`;
        this.ui.finalAccuracy.textContent = `${accuracy}%`;
        this.ui.correctCount.textContent = this.score;
        this.ui.incorrectCount.textContent = this.questions.length - this.score;


        // Detailed Feedback Generation
        this.ui.feedbackList.innerHTML = '';
        
        const incorrectAnswers = this.userHistory.filter(h => h && !h.isCorrect);
        
        if (incorrectAnswers.length === 0) {
          this.ui.feedbackSummary.textContent = 'Faultless.';
          this.ui.feedbackList.innerHTML = ''; 
        } else {
          this.ui.feedbackSummary.textContent = 'Review the items below to tighten your knowledge.';
          this.userHistory.forEach((answer, index) => {
            if(answer && !answer.isCorrect){
              const q = this.questions[index];
              const correctOption = q.options.find(o => o.correct);
              
              // Handle Timed Out vs Wrong Selection
              let userText = '';
              if (answer.timedOut) {
                userText = '<span style="color:var(--secondColour); font-style:italic">Time Out (No answer)</span>';
              } else {
                const selectedOption = q.options[answer.selectedIndex];
                userText = `<span class="font-semibold">${selectedOption.text}</span>`;
              }

              const card = document.createElement('div');
              card.className = 'card p-4 rounded-lg'; 
              card.innerHTML = `
                <p class="font-bold text-secondary">${index + 1}. ${q.question}</p>
                <p class="mt-2 text-secondary">Your answer: ${userText}</p>
                <p class="mt-1 text-heading">Correct answer: <span class="font-semibold">${correctOption.text}</span></p>
                ${q.explanation ? `<p class="mt-2 text-sm muted"><span class="font-semibold text">Explanation:</span> ${q.explanation}</p>` : ''}
              `;
              this.ui.feedbackList.appendChild(card);
            }
          });
        }
        window.scrollTo(0, 0);
      }
    };

    // --- EVENT LISTENERS ---

    document.getElementById('btn-load').addEventListener('click', () => QuizApp.loadData());

    document.getElementById('btn-next').addEventListener('click', () => QuizApp.nextQuestion());

    document.getElementById('btn-restart').addEventListener('click', () => {
      QuizApp.questions = QuizApp.shuffle(QuizApp.questions).map(q => ({ ...q, options: QuizApp.shuffle(q.options) }));
      QuizApp.startQuiz();
    });

    document.addEventListener('keydown', (e) => {
      if (QuizApp.ui.quizView.classList.contains('hidden')) return;

      const key = e.key.toLowerCase();
      const letters = ['a','b','c','d','e'];

      if (letters.includes(key)) {
        const idx = letters.indexOf(key);
        const options = QuizApp.ui.optionsList.children;
        
        if (idx < options.length) {
          e.preventDefault();
          if (e.shiftKey) {
            QuizApp.toggleDiscard(options[idx]);
          } else {
            QuizApp.handleAnswer(idx);
          }
        }
      }
      else if (key === 'n') {
        if (!QuizApp.ui.btnNext.disabled) {
          QuizApp.nextQuestion();
        }
      }
    });

    document.addEventListener("DOMContentLoaded", function() {
      const yearPlaceholder = document.getElementById("yearPlaceholder");
      if (yearPlaceholder) {
        yearPlaceholder.textContent = new Date().getFullYear();
      }
    });
  </script>
</body>
</html>
